/*
 * Flocking MIDI Node.js System
 * http://github.com/colinbdclark/flocking-midi
 *
 * Copyright 2016, Colin Clark
 * Licensed under the MIT license.
 */

"use strict";

var fluid = fluid || require("infusion"),
    flock = fluid.registerNamespace("flock");

fluid.defaults("flock.midi.nodejs.system", {
    gradeNames: "flock.midi.system",

    sysex: false,

    pollForPortChanges: false,
    pollRate: 1,

    model: {
        inputs: {},
        outputs: {}
    },

    components: {
        access: {
            type: "flock.midi.nodejs.access"
        },

        portMonitor: {
            type: "flock.midi.nodejs.portMonitor",
            options: {
                pollRate: "{system}.options.pollRate",
                model: {
                    isActive: "{system}.options.pollForPortChanges"
                }
            }
        }
    },

    invokers: {
        requestAccess: "{that}.events.onReady.fire()",
        refreshPorts: {
            funcName: "flock.midi.nodejs.system.updatePorts",
            args: ["{that}.access", "{that}.applier"]
        }
    },

    listeners: {
        "onReady.updatePorts": "{that}.refreshPorts()"
    }
});

flock.midi.nodejs.system.modelizePort = function (type, portNum, access) {
    return {
        type: type,
        id: portNum, // TODO: Generate a suitable ID; store the port number differently.
        name: access[type].getPortName(portNum),
        manufacturer: undefined, // node-midi/RtMidi doesn't give us manufacturer info.
        state: "connected",
        connection: "closed",
    };
};

flock.midi.nodejs.system.modelizePorts = function (type, access) {
    var numPorts = access[type].getPortCount(),
        ports = [];

    for (var i = 0; i < numPorts; i++) {
        ports[i] = flock.midi.nodejs.system.modelizePort(type, i, access);
    }

    return ports;
};

// TODO: This implementation is VERY similar to that in the Web MIDI implementation.
flock.midi.nodejs.system.updatePorts = function (access, applier) {
    var updatedModel = {
        inputs: flock.midi.nodejs.system.modelizePorts("input", access),
        outputs: flock.midi.nodejs.system.modelizePorts("output", access)
    };

    applier.change("", updatedModel);
};
