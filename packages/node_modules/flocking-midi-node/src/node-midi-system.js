/*
 * Flocking MIDI Node.js System
 * http://github.com/colinbdclark/flocking-midi
 *
 * Copyright 2016, Colin Clark
 * Licensed under the MIT license.
 */

"use strict";

var fluid = fluid || require("infusion"),
    flock = fluid.registerNamespace("flock");

fluid.makeGradeLinkage("flock.midi.nodejs.systemLinker",
    ["flock.midi.system"], "flock.midi.nodejs.system");

fluid.defaults("flock.midi.nodejs.system", {
    gradeNames: "flock.midi.system",

    sysex: false,

    pollForPortChanges: false,
    pollRate: 1,

    components: {
        access: {
            type: "flock.midi.nodejs.access"
        },

        portMonitor: {
            type: "flock.midi.nodejs.portMonitor",
            options: {
                pollRate: "{system}.options.pollRate",
                model: {
                    isActive: "{system}.options.pollForPortChanges"
                }
            }
        }
    },

    invokers: {
        modelizePorts: {
            funcName: "flock.midi.nodejs.system.modelizePorts",
            args: ["{that}.access", "{that}.events.afterPortsModelized.fire"]
        }
    }
});


// Note: This strategy will fail to recognize multiple ports with the same name.
// RtMidi does not guarantee unique names across all platforms, nor does it provide
// any form of identification or description of ports. It is of
// such poor quality that it essentially can't reliably support dynamic changes
// of the list of ports.
//
// In practice, this seems to primarily affect Mac OS X users. If you're using
// multiple devices with the same name on OS X, use Audio Midi Setup to give them
// unique names.
//
// For more information, see: https://github.com/thestk/rtmidi/pull/30
flock.midi.nodejs.system.assignPortID = function (portSpec) {
    var id = portSpec.name + "-" + portSpec.type;
    portSpec.id = id;

    return id;
};

flock.midi.nodejs.system.modelizePort = function (type, portNum, access) {
    var portSpec = {
        type: type,
        num: portNum,
        name: access[type].getPortName(portNum),
        manufacturer: undefined, // RtMidi doesn't provide manufacturer info.
        state: "connected",
        connection: access[type].isPortOpen(portNum) ? "open" : "closed"
    };

    flock.midi.nodejs.system.assignPortID(portSpec);

    return portSpec;
};

flock.midi.nodejs.system.modelizePortsOfType = function (type, access, portsModel) {
    var numPorts = access[type].getPortCount();

    for (var i = 0; i < numPorts; i++) {
        var portSpec = flock.midi.nodejs.system.modelizePort(type, i, access);
        portsModel[portSpec.id] = portSpec;
    }

    return portsModel;
};

flock.midi.nodejs.system.modelizePorts = function (access, afterPortsModelized) {
    var portsModel = {};
    flock.midi.nodejs.system.modelizePortsOfType("input", access, portsModel);
    flock.midi.nodejs.system.modelizePortsOfType("output", access, portsModel);
    afterPortsModelized(portsModel);

    return portsModel;
};
