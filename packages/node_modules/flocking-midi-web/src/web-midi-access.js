/*
 * Flocking Web MIDI Access
 * http://github.com/colinbdclark/flocking-midi
 *
 * Copyright 2014-2016, Colin Clark
 * Licensed under the MIT license.
 */

"use strict";

fluid.defaults("flock.midi.web.access", {
    gradeNames: "flock.midi.access",

    sysex: false,

    members: {
        requestTarget: navigator
    },

    invokers: {
        requestAccess: {
            funcName: "flock.midi.web.requestAccess",
            args: [
                "{that}.options.sysex",
                "{that}.requestTarget",
                "{that}.events"
            ]
        }
    },

    events: {
        onNoWebMIDISupport: null,
        onPortChange: null
    },

    listeners: {
        "onNoWebMIDISupport.logToConsole": {
            funcName: "fluid.log",
            args: [fluid.logLevel.WARN, "{arguments}.0"]
        },

        "onNoWebMIDISupport.fireErrorEvent": {
            func: "{that}.events.onError.fire",
            args: ["{arguments}.0"]
        },

        "afterAccessGranted.stashAccessObject": {
            funcName: "flock.midi.web.access.stashAccessObject",
            args: ["{arguments}.0", "{that}"]
        },

        "afterAccessGranted.bindPortChange": {
            funcName: "flock.midi.web.access.bindPortChange",
            args: ["{arguments}.0", "{that}.events.onPortChange.fire"]
        }
    }
});

flock.midi.web.access.bindPortChange = function (access, onPortChange) {
    access.addEventListener("statechange", function (evt) {
        onPortChange(evt.port);
    });
};

flock.midi.web.requestAccess = function (sysex, requestTarget, events) {
    if (!requestTarget.requestMIDIAccess) {
        return events.onNoWebMIDISupport.fire(
            "The Web MIDI API is not available in this browser.");
    }

    flock.midi.access.requestAccess(sysex, requestTarget, events.onAccessRequested.fire);
};

flock.midi.web.access.stashAccessObject = function (access, that) {
    that.access = access;
};
